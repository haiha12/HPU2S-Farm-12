<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± √°n qu√©t b·ªánh l√° ch√® v·ªõi YOLO11</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5806/5806342.png">
    <style>
    /* 1. IMPORT FONT CH·ªÆ HI·ªÜN ƒê·∫†I (Google Fonts) */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

    /* 2. C·∫§U H√åNH CHUNG */
    body { 
        font-family: 'Poppins', sans-serif; /* Font ch·ªØ tr√≤n, hi·ªán ƒë·∫°i */
        /* N·ªÅn Gradient H·ªìng - Cam ƒë√†o si√™u xinh */
        background: linear-gradient(135deg, #b5fffd 0%, #ffc9ee 99%, #ff8cdb 100%); 
        background-attachment: fixed; /* Gi·ªØ n·ªÅn c·ªë ƒë·ªãnh khi cu·ªôn */
        color: #333; /* Ch·ªØ m√†u t·ªëi ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n n·ªÅn s√°ng */
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        min-height: 100vh; 
        margin: 0; 
    }

    /* 3. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P */
    #login-screen { 
        text-align: center; 
        background: rgba(255, 255, 255, 0.9); /* N·ªÅn tr·∫Øng m·ªù */
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(255, 105, 135, 0.3); /* B√≥ng ƒë·ªï m√†u h·ªìng */
        backdrop-filter: blur(10px); /* Hi·ªáu ·ª©ng k√≠nh */
    }
    
    h1 { color: #ff6b81; margin-bottom: 10px; font-weight: 700; }
    p { color: #666; margin-bottom: 30px; }

    .btn-google { 
        background: white; 
        color: #555; 
        padding: 12px 30px; 
        border: 1px solid #eee; 
        border-radius: 50px; /* Bo tr√≤n ho√†n to√†n */
        font-size: 16px; 
        font-weight: 600;
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        margin: 0 auto; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-google:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 6px 20px rgba(0,0,0,0.1); 
    }

    /* 4. M√ÄN H√åNH CH√çNH */
    #app-screen { 
        display: none; 
        text-align: center; 
        width: 100%;
        max-width: 800px;
    }

    /* User Info */
    .user-info { 
        background: rgba(255,255,255,0.8);
        padding: 10px 20px;
        border-radius: 50px;
        display: inline-flex;
        align-items: center; 
        gap: 15px; 
        justify-content: center; 
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; }
    #userName { font-weight: 600; color: #444; }

    /* Khung Video (Glassmorphism) */
    .container { 
        position: relative; 
        width: 640px; 
        height: 480px; 
        background: #000; 
        border-radius: 20px; /* Bo g√≥c m·ªÅm m·∫°i */
        overflow: hidden; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        margin: 0 auto;
        border: 5px solid rgba(255,255,255,0.5); /* Vi·ªÅn k√≠nh tr·∫Øng */
    }
    
    video, canvas { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
    }

    /* 5. C√ÅC N√öT ƒêI·ªÄU KHI·ªÇN */
    .controls { margin-top: 25px; display: flex; gap: 20px; align-items: center; justify-content: center; }
    
    button { 
        padding: 12px 30px; 
        border: none; 
        border-radius: 50px; 
        cursor: pointer; 
        font-weight: 700; 
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Gradient Buttons */
    .btn-start { 
        background: linear-gradient(45deg, #ff9a9e, #fad0c4); 
        color: #fff; 
        box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);
    }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 154, 158, 0.6); }

    .btn-stop { 
        background: linear-gradient(45deg, #ff758c, #ff7eb3); 
        color: white; 
        box-shadow: 0 4px 15px rgba(255, 117, 140, 0.4);
    }
    
    .btn-logout { 
        background: transparent; 
        color: #ff6b81; 
        border: 2px solid #ff6b81; 
        padding: 6px 15px;
        font-size: 14px;
    }
    .btn-logout:hover { background: #ff6b81; color: white; }

    button:disabled { background: #e0e0e0; color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

    /* 6. B·∫¢NG TH√îNG TIN (INFO PANEL) */
    .info-panel {
        width: 640px;
        display: flex;
        gap: 20px;
        margin: 20px auto 0 auto;
    }

    .card {
        flex: 1;
        background: rgba(255, 255, 255, 0.9); /* N·ªÅn tr·∫Øng s·∫°ch */
        padding: 20px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        border-left: none; /* B·ªè vi·ªÅn c≈© */
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Thanh tr·∫°ng th√°i nh·ªè b√™n tr√°i thay cho vi·ªÅn to */
    .card::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 6px;
        background: #ddd;
    }

    .card .icon { font-size: 36px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .card .label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; margin-bottom: 4px; }
    .card .value { font-size: 18px; font-weight: 700; color: #333; margin: 0; }
    .card .sub-value { font-size: 13px; color: #666; font-weight: 400; }

    /* Tr·∫°ng th√°i An to√†n (Xanh Mint) */
    .card.safe::before { background: #48c6ef; } 
    .card.safe .value { color: #20bf6b; }
    
    /* Tr·∫°ng th√°i Nguy hi·ªÉm (ƒê·ªè H·ªìng) */
    .card.danger::before { background: #ff758c; }
    .card.danger { background: #fff0f3; } /* N·ªÅn h·ªìng nh·∫°t b√°o ƒë·ªông */
    .card.danger .value { color: #ff4757; }

    /* Text status ch√¢n trang */
    .footer-status { margin-top: 15px; color: #555; font-size: 14px; }
    .footer-status span { font-weight: bold; color: #ff6b81; }

    /* N√∫t c√†i ƒë·∫∑t h√¨nh tr√≤n */
.btn-settings {
    background: white;
    color: #555;
    width: 45px;
    height: 45px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.btn-settings:hover { transform: rotate(90deg); background: #f8f9fa; }

/* Modal (Pop-up) */
.modal {
    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
    position: fixed; 
    z-index: 1000; 
    left: 0; top: 0; 
    width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.5); /* N·ªÅn t·ªëi m·ªù */
    backdrop-filter: blur(5px);
    align-items: center; justify-content: center;
}

/* Hi·ªáu ·ª©ng hi·ªán modal */
.modal.show { display: flex; animation: fadeIn 0.3s; }

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    width: 400px;
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    overflow: hidden;
}

.modal-header {
    background: linear-gradient(135deg, #ff9a9e, #fad0c4);
    padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
    color: white;
}
.modal-header h3 { margin: 0; font-size: 18px; }
.close-btn { font-size: 28px; cursor: pointer; line-height: 20px; }
.close-btn:hover { color: #ffe3e3; }

.modal-body { padding: 20px; }
.desc { font-size: 13px; color: #666; margin-top: 0; }

/* H√†ng √¢m thanh */
.sound-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
}
.sound-label { display: flex; flex-direction: column; }
.sound-label span { font-weight: 600; font-size: 14px; color: #444; }
.status-text { font-size: 11px; color: #888; }
.status-text.active { color: #28a745; font-weight: bold; }

/* N√∫t upload custom */
.custom-file-upload {
    border: 1px solid #ddd;
    display: inline-block;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 20px;
    font-size: 12px;
    color: #555;
    transition: 0.2s;
}
.custom-file-upload:hover { background: #eee; }
input[type="file"] { display: none; } /* ·∫®n input x·∫•u x√≠ ƒëi */

.test-sound { margin-top: 20px; text-align: center; }
.btn-test { background: #eee; color: #333; font-size: 13px; padding: 8px 20px; }
.btn-test:hover { background: #ddd; }

@keyframes fadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
</style>
</head>
<body>

    <div id="login-screen">
        <h1>üåø Tea Leaf Doctor AI</h1>
        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√©t b·ªánh c√¢y ch√®.</p>
        <button id="btnLogin" class="btn-google">
            <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"></path><path fill="#fff" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"></path><path fill="#fff" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"></path><path fill="#fff" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z"></path></svg>
            ƒêƒÉng nh·∫≠p b·∫±ng Google
        </button>
    </div>

    <div id="app-screen">
        <div class="user-info">
            <img id="userAvatar" class="user-avatar" src="" alt="">
            <span id="userName">User</span>
            <button id="btnLogout" class="btn-logout">ƒêƒÉng xu·∫•t</button>
        </div>

        <div class="container">
            <video id="videoElement" width="640" height="480" muted playsinline></video>
            <canvas id="outputCanvas" width="640" height="480"></canvas>
        </div>
        <div class="info-panel">
            <div class="card time-card">
                <div class="icon">üïí</div>
                <div>
                    <div class="label">Th·ªùi gian th·ª±c</div>
                    <div id="clockDisplay" class="value">--:--:--</div>
                    <div id="dateDisplay" class="sub-value">--/--/----</div>
                </div>
        </div>

    <div class="card result-card" id="resultCard">
        <div class="icon" id="statusIcon">üîç</div>
        <div>
            <div class="label">Ch·∫©n ƒëo√°n AI</div>
            <div id="diseaseName" class="value">ƒêang ch·ªù qu√©t...</div>
            <div id="confidenceLevel" class="sub-value">ƒê·ªô tin c·∫≠y: --%</div>
        </div>
    </div>
</div>

        <div class="controls">
            <button id="startBtn" class="btn-start">B·∫¨T CAMERA</button>
            <button id="stopBtn" class="btn-stop" disabled>D·ª™NG</button>
            <button id="btnSettings" class="btn-settings" title="C·∫•u h√¨nh c·∫£nh b√°o">‚öôÔ∏è</button>
        </div>

        <div class="footer-status" style="margin-top: 10px; color: #aaa;">
            Tr·∫°ng th√°i: <span id="status">S·∫µn s√†ng</span> | FPS: <span id="fps">0</span>
        </div>
    </div>
    <div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚öôÔ∏è C·∫•u h√¨nh C·∫£nh b√°o</h3>
            <span class="close-btn" id="closeSettings">&times;</span>
        </div>
        
        <div class="modal-body">
            <p class="desc">H·ªá th·ªëng s·ª≠ d·ª•ng √¢m thanh m·∫∑c ƒë·ªãnh. B·∫°n c√≥ th·ªÉ t·∫£i l√™n file ri√™ng (.mp3/.wav).</p>
            
            <div class="sound-row">
                <div class="sound-label">
                    <span>B·ªánh Ch·∫•m X√°m</span>
                    <small id="status-cham_xam" class="status-text">ƒêang d√πng m·∫∑c ƒë·ªãnh</small>
                </div>
                <label class="custom-file-upload">
                    <input type="file" id="input-cham_xam" accept="audio/*">
                    Thay ƒë·ªïi
                </label>
            </div>

            <div class="sound-row">
                <div class="sound-label">
                    <span>B·ªánh Th·ªëi R·ªÖ</span>
                    <small id="status-thoi_re" class="status-text">ƒêang d√πng m·∫∑c ƒë·ªãnh</small>
                </div>
                <label class="custom-file-upload">
                    <input type="file" id="input-thoi_re" accept="audio/*">
                    Thay ƒë·ªïi
                </label>
            </div>

            <div class="sound-row">
                <div class="sound-label">
                    <span>C·∫£nh b√°o chung</span>
                    <small id="status-general" class="status-text">ƒêang d√πng m·∫∑c ƒë·ªãnh</small>
                </div>
                <label class="custom-file-upload">
                    <input type="file" id="input-general" accept="audio/*">
                    Thay ƒë·ªïi
                </label>
            </div>

            <div class="test-sound">
                <button id="btnTestSound" class="btn-test">üîä Nghe th·ª≠ √¢m thanh hi·ªán t·∫°i</button>
            </div>
        </div>
    </div>
</div>

</body>


    <script type="module">

        // === QU·∫¢N L√ù √ÇM THANH (N√¢ng cao) ===

// 1. √Çm thanh m·∫∑c ƒë·ªãnh (Ti·∫øng B√≠p chu·∫©n - Base64)
// Kh√¥ng c·∫ßn t·∫£i file, ch·∫°y l√† c√≥ ti·∫øng ngay
const DEFAULT_BEEP_URL = "./alarm.mp3";
// --- TH√äM D√íNG N√ÄY ƒê·ªÇ S·ª¨A L·ªñI ---
const BEEP_URL = DEFAULT_BEEP_URL; // G√°n l·∫°i ƒë·ªÉ code c≈© kh√¥ng b·ªã l·ªói
// C·∫•u h√¨nh √¢m thanh hi·ªán t·∫°i
const soundConfig = {
    'cham_xam': { url: DEFAULT_BEEP_URL, isCustom: false },
    'thoi_re':  { url: DEFAULT_BEEP_URL, isCustom: false },
    'general':  { url: DEFAULT_BEEP_URL, isCustom: false }
};

let currentAudio = new Audio();
let lastAlertTime = 0;
const ALERT_COOLDOWN = 3000;

// === LOGIC MODAL (POPUP) ===
const modal = document.getElementById("settingsModal");
const btnSettings = document.getElementById("btnSettings");
const spanClose = document.getElementById("closeSettings");

// M·ªü Modal
btnSettings.onclick = () => modal.classList.add("show");
// ƒê√≥ng Modal
spanClose.onclick = () => modal.classList.remove("show");
// B·∫•m ra ngo√†i c≈©ng ƒë√≥ng
window.onclick = (event) => {
    if (event.target == modal) modal.classList.remove("show");
}

// --- 1. H√ÄM X·ª¨ L√ù DATABASE (INDEXED DB) ---
// Gi√∫p l∆∞u file v√†o b·ªô nh·ªõ tr√¨nh duy·ªát
const DB_NAME = "TeaDoctorAudioDB";
const DB_VERSION = 1;

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("audios")) {
                db.createObjectStore("audios"); // T·∫°o kho ch·ª©a
            }
        };
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject("L·ªói m·ªü DB");
    });
}

async function saveAudioToDB(key, fileBlob) {
    const db = await openDB();
    const tx = db.transaction("audios", "readwrite");
    tx.objectStore("audios").put(fileBlob, key); // L∆∞u file v·ªõi t√™n key (vd: cham_xam)
}

async function loadAllAudiosFromDB() {
    const db = await openDB();
    const tx = db.transaction("audios", "readonly");
    const store = tx.objectStore("audios");
    
    // Duy·ªát qua c√°c key c·∫•u h√¨nh ƒë·ªÉ load
    ['cham_xam', 'thoi_re', 'general'].forEach(key => {
        const request = store.get(key);
        request.onsuccess = () => {
            const fileBlob = request.result;
            if (fileBlob) {
                // N·∫øu t√¨m th·∫•y file ƒë√£ l∆∞u -> T·∫°o link v√† c·∫≠p nh·∫≠t
                const audioUrl = URL.createObjectURL(fileBlob);
                soundConfig[key] = { url: audioUrl, isCustom: true };
                
                // C·∫≠p nh·∫≠t giao di·ªán ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt
                updateUIStatus(key, "ƒê√£ kh√¥i ph·ª•c file c≈©");
                console.log(`‚úÖ ƒê√£ load l·∫°i √¢m thanh cho: ${key}`);
            }
        };
    });
}

// --- 2. H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
function updateUIStatus(key, message) {
    const statusEl = document.getElementById(`status-${key}`);
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.classList.add("active");
        statusEl.style.color = "#28a745";
    }
}

// --- 3. LOGIC UPLOAD & EVENT ---
function setupSoundSystem() {
    // A. Load file c≈© ngay khi v√†o trang
    loadAllAudiosFromDB();

    // B. L·∫Øng nghe s·ª± ki·ªán upload m·ªõi
    const keys = ['cham_xam', 'thoi_re', 'general'];
    keys.forEach(key => {
        const input = document.getElementById(`input-${key}`);
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                // 1. T·∫°o URL ƒë·ªÉ d√πng ngay
                const objectUrl = URL.createObjectURL(file);
                soundConfig[key] = { url: objectUrl, isCustom: true };
                
                // 2. L∆∞u v√†o DB ƒë·ªÉ l·∫ßn sau d√πng l·∫°i
                await saveAudioToDB(key, file);
                
                // 3. C·∫≠p nh·∫≠t UI
                updateUIStatus(key, `ƒê√£ l∆∞u: ${file.name}`);
                
                // 4. K√™u th·ª≠
                playAudioImmediate(objectUrl);
            }
        };
    });

    // C. N√∫t nghe th·ª≠
    const btnTest = document.getElementById('btnTestSound');
    if(btnTest) btnTest.onclick = () => playAlarm('general', true);
}

// G·ªçi h√†m kh·ªüi t·∫°o
setupSoundSystem();


// --- 4. H√ÄM PH√ÅT C·∫¢NH B√ÅO (CORE) ---
function playAlarm(label, force = false) {
    const now = performance.now();
    
    // Check cooldown
    if (!force && (now - lastAlertTime < ALERT_COOLDOWN)) return;

    // L·∫•y config
    const config = soundConfig[label] || soundConfig['general'];
    
    // Ph√°t
    playAudioImmediate(config.url);
    lastAlertTime = now;
}

function playAudioImmediate(url) {
    if (!currentAudio) currentAudio = new Audio();
    
    // Tr√°nh l·ªói source null
    if (!url) return;

    currentAudio.src = url;
    currentAudio.play().catch(e => {
        console.warn("Ch∆∞a th·ªÉ ph√°t ti·∫øng (C·∫ßn click v√†o trang tr∆∞·ªõc):", e);
    });
}



        // Import c√°c h√†m c·∫ßn thi·∫øt t·ª´ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- C·∫§U H√åNH FIREBASE (D√°n config c·ªßa b·∫°n v√†o ƒë√¢y) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDidIP3t7f6GFB_GdySvtdo7RhJESYlQDg",
            authDomain: "txt2-1e646.firebaseapp.com",
            projectId: "txt2-1e646",
            storageBucket: "txt2-1e646.firebasestorage.app",
            messagingSenderId: "968092612725",
            appId: "1:968092612725:web:ef44c18ee5c25f2f4de03c",
            measurementId: "G-GZB6L3MY1L"
        };
        // === T·ª™ ƒêI·ªÇN T√äN B·ªÜNH (Vi·ªát h√≥a) ===
const DISEASE_MAP = {
    'cham_xam': 'B·ªánh Ch·∫•m X√°m',
    'chay_bup': 'B·ªánh Th·ªëi B√∫p',
    'dom_la': 'B·ªç x√≠t mu·ªói',
    'chay_la': 'B·ªánh ƒë·ªëm n√¢u',
    'phong_la': 'B·ªánh ph·ªìng l√°',
    // Th√™m c√°c label kh√°c t·ª´ data.yaml c·ªßa b·∫°n v√†o ƒë√¢y
    'default': 'Kh√¥ng x√°c ƒë·ªãnh'
};

// === 1. H√ÄM ƒê·ªíNG H·ªí REAL-TIME ===
function startClock() {
    setInterval(() => {
        const now = new Date();
        document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('vi-VN');
        document.getElementById('dateDisplay').textContent = now.toLocaleDateString('vi-VN');
    }, 1000);
}

// G·ªçi h√†m n√†y ngay khi trang t·∫£i xong
startClock();

// === 2. H√ÄM C·∫¨P NH·∫¨T K·∫æT QU·∫¢ (G·ªçi trong ws.onmessage) ===
function updateDashboard(detections) {
    const resultCard = document.getElementById('resultCard');
    const nameEl = document.getElementById('diseaseName');
    const confEl = document.getElementById('confidenceLevel');
    const iconEl = document.getElementById('statusIcon');
    if (!detections) detections = [];
    if (detections.length > 0) {
        // L·∫•y k·∫øt qu·∫£ c√≥ ƒë·ªô tin c·∫≠y cao nh·∫•t
        // (Gi·∫£ s·ª≠ model tr·∫£ v·ªÅ m·∫£ng ƒë√£ sort, ho·∫∑c l·∫•y c√°i ƒë·∫ßu ti√™n)
        const bestDet = detections[0]; 
        
        // D·ªãch t√™n b·ªánh
        const vnName = DISEASE_MAP[bestDet.label] || bestDet.label;
        const confPercent = Math.floor(bestDet.conf * 100);
        // T√¨m ƒëo·∫°n n√†y trong updateDashboard

        // S·ª≠a l·∫°i ƒëo·∫°n g·ªçi playAlarm:
        // H·∫° th·∫•p ng∆∞·ª°ng xu·ªëng 0.3 (30%) ƒë·ªÉ test cho d·ªÖ k√™u
        if (bestDet.conf > 0.3) { 
            console.log(`‚ö° Ph√°t hi·ªán b·ªánh! ƒêi·ªÉm: ${bestDet.conf}`); // Log xem n√≥ c√≥ v√†o ƒë√¢y kh√¥ng
            playAlarm(bestDet.label);
        } else {
            console.log(`‚ö†Ô∏è C√≥ b·ªánh nh∆∞ng ƒëi·ªÉm th·∫•p (${bestDet.conf}), kh√¥ng k√™u.`);
        }
        // C·∫≠p nh·∫≠t giao di·ªán: C·∫¢NH B√ÅO (ƒê·ªé)
        resultCard.className = "card danger";
        nameEl.textContent = vnName;
        nameEl.style.color = "#ff6b6b"; // Ch·ªØ ƒë·ªè nh·∫°t
        confEl.textContent = `ƒê·ªô tin c·∫≠y: ${confPercent}%`;
        iconEl.textContent = "‚ö†Ô∏è";
    } else {
        // Kh√¥ng t√¨m th·∫•y g√¨: AN TO√ÄN (XANH)
        resultCard.className = "card safe";
        nameEl.textContent = "C√¢y kh·ªèe m·∫°nh";
        nameEl.style.color = "#28a745";
        confEl.textContent = "ƒêang qu√©t...";
        iconEl.textContent = "üåø";
    }
}
        // Kh·ªüi t·∫°o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // === DOM ELEMENTS & VARS ===
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        
        // --- LOGIC ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T ---
        
        // 1. L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Ng∆∞·ªùi d√πng ƒê√É ƒëƒÉng nh·∫≠p
                console.log("User:", user.displayName);
                loginScreen.style.display = "none";
                appScreen.style.display = "block";
                
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
            } else {
                // Ng∆∞·ªùi d√πng CH∆ØA ƒëƒÉng nh·∫≠p
                loginScreen.style.display = "block";
                appScreen.style.display = "none";
                stopStreaming(); // D·ª´ng camera n·∫øu l·ª° ƒëang ch·∫°y
            }
        });

        // 2. X·ª≠ l√Ω n√∫t ƒêƒÉng nh·∫≠p
        btnLogin.onclick = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            }
        };

        // 3. X·ª≠ l√Ω n√∫t ƒêƒÉng xu·∫•t
        btnLogout.onclick = () => {
            signOut(auth);
        };

        // --- LOGIC CAMERA & AI (Ph·∫ßn c≈© ƒë√£ s·ª≠a l·ªói) ---
        
        const WS_URL = "https://thanhtxt0147-txtdetectleaf.hf.space/ws";
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusSpan = document.getElementById('status');
        const fpsSpan = document.getElementById('fps');

        let ws = null;
        let isStreaming = false;
        let isProcessing = false;
        let latestDetections = [];
        let frameCount = 0;
        let lastFrameTime = 0;
        let lastDetectionTime = 0; // Th·ªùi ƒëi·ªÉm nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ cu·ªëi c√πng
        // Cho ph√©p c√°c h√†m b√™n d∆∞·ªõi ƒë∆∞·ª£c g·ªçi t·ª´ global scope (do d√πng type="module")
        window.startStreaming = async () => { /* ... */ }; 

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            statusSpan.textContent = "ƒêang m·ªü camera...";
            // 1. C·ªê G·∫ÆNG M·ªû KH√ìA √ÇM THANH (M·ªìi)
    try {
        if (!currentAudio) currentAudio = new Audio();
        
        // N·∫øu ch∆∞a c√≥ src, d√πng link m·∫∑c ƒë·ªãnh ƒë·ªÉ m·ªìi
        if (!currentAudio.src || currentAudio.src === "") {
            currentAudio.src = BEEP_URL;
        }

        // Ph√°t v√† d·ª´ng ngay l·∫≠p t·ª©c ƒë·ªÉ xin quy·ªÅn tr√¨nh duy·ªát
        await currentAudio.play();
        currentAudio.pause();
        currentAudio.currentTime = 0;
        console.log("‚úÖ ƒê√£ m·ªü kh√≥a √¢m thanh!");
    } catch (err) {
        // N·∫øu l·ªói √¢m thanh, CH·ªà in log warning, KH√îNG l√†m ch·∫øt app
        console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ m·ªü kh√≥a √¢m thanh (Nh∆∞ng v·∫´n m·ªü Camera):", err);
    }


            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: "environment" } 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.play();
                    
                    isStreaming = true;
                    stopBtn.disabled = false;
                    statusSpan.textContent = "ƒêang k·∫øt n·ªëi Server...";
                    requestAnimationFrame(processFrame);
                    connectWebSocket();
                };
            } catch (err) {
                alert("L·ªói Camera: " + err.message);
                startBtn.disabled = false;
            }
        };

        stopBtn.onclick = stopStreaming;

        function stopStreaming() {
            isStreaming = false;
            if (ws) ws.close();
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusSpan.textContent = "ƒê√£ d·ª´ng";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        // === H√ÄM V·∫º KHUNG CH·ªÆ NH·∫¨T L√äN VIDEO ===
function drawBoxes(detections) {
    // 1. X√≥a c√°c khung h√¨nh c≈© ƒëi ƒë·ªÉ v·∫Ω khung m·ªõi
    // (N·∫øu kh√¥ng x√≥a, c√°c khung s·∫Ω ch·ªìng ch√©o l√™n nhau r·∫•t r·ªëi)
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 2. V·∫Ω l·∫°i h√¨nh ·∫£nh video l√†m n·ªÅn (N·∫øu canvas n·∫±m ƒë√® l√™n video)
    // L∆∞u √Ω: N·∫øu b·∫°n d√πng CSS ƒë·ªÉ ƒë·∫∑t canvas ƒë√® l√™n video th√¨ d√≤ng d∆∞·ªõi c√≥ th·ªÉ b·ªè. 
    // Nh∆∞ng ƒë·ªÉ ch·∫Øc ch·∫Øn, ta c·ª© v·∫Ω l·∫°i ·∫£nh video.
    // ctx.drawImage(video, 0, 0, canvas.width, canvas.height); 
    // (T·∫°m th·ªùi b·ªè d√≤ng tr√™n n·∫øu b·∫°n d√πng style position:absolute cho canvas)

    // 3. Duy·ªát qua t·ª´ng k·∫øt qu·∫£ ƒë·ªÉ v·∫Ω
    detections.forEach(det => {
        // L·∫•y t·ªça ƒë·ªô
        const [x1, y1, x2, y2] = det.box;
        const width = x2 - x1;
        const height = y2 - y1;
        
        // Ch·ªçn m√†u s·∫Øc: N·∫øu l√† 'general' (ho·∫∑c healthy) th√¨ m√†u xanh, b·ªánh th√¨ m√†u ƒë·ªè
        const isSafe = det.label === 'healthy' || det.label === 'khoe_manh';
        const color = isSafe ? '#00FF00' : '#FF0000'; // Xanh ho·∫∑c ƒê·ªè

        // B·∫Øt ƒë·∫ßu v·∫Ω khung
        ctx.beginPath();
        ctx.lineWidth = 3;
        ctx.strokeStyle = color;
        ctx.rect(x1, y1, width, height);
        ctx.stroke();

        // V·∫Ω n·ªÅn cho ch·ªØ (ƒë·ªÉ d·ªÖ ƒë·ªçc)
        ctx.fillStyle = color;
        ctx.font = '18px Arial';
        const text = `${det.label} (${Math.round(det.conf * 100)}%)`;
        const textWidth = ctx.measureText(text).width;
        
        ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);

        // Vi·∫øt ch·ªØ t√™n b·ªánh
        ctx.fillStyle = '#FFFFFF'; // Ch·ªØ m√†u tr·∫Øng
        ctx.fillText(text, x1 + 5, y1 - 7);
    });
}
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            ws.binaryType = "blob";

            ws.onopen = () => {
                statusSpan.textContent = "ƒêang ch·∫°y AI";
                statusSpan.style.color = "#28a745";
                processFrame();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                // --- S·ª¨A: KI·ªÇM TRA D·ªÆ LI·ªÜU AN TO√ÄN ---
                // N·∫øu data l√† null ho·∫∑c undefined, coi nh∆∞ m·∫£ng r·ªóng []
                const detections = Array.isArray(data) ? data : [];

                latestDetections = data.detections;
                lastDetectionTime = performance.now();

                // G·ªçi c√°c h√†m v·∫Ω v√† c·∫≠p nh·∫≠t
                drawBoxes(detections);
                updateDashboard(detections); // C·∫≠p nh·∫≠t th·ªùi gian nh·∫≠n
                isProcessing = false;
                calculateFPS();
            };

            ws.onclose = () => {
                if(isStreaming) statusSpan.textContent = "M·∫•t k·∫øt n·ªëi Server";
            };
        }

       let lastSentTime = 0;
const SEND_INTERVAL = 200; // 200ms = 5 khung h√¨nh/gi√¢y (Gi·∫£m t·∫£i cho server)

function processFrame(currentTime) {
    // A. QUAN TR·ªåNG NH·∫§T: Duy tr√¨ v√≤ng l·∫∑p
    // G·ªçi l·∫°i h√†m n√†y cho khung h√¨nh ti·∫øp theo ngay l·∫≠p t·ª©c
    // L∆∞u √Ω: Ph·∫£i g·ªçi d√≤ng n√†y b·∫•t k·ªÉ c√≥ g·ª≠i ·∫£nh hay kh√¥ng
    requestAnimationFrame(processFrame);

    // B. Ki·ªÉm tra ƒëi·ªÅu ki·ªán d·ª´ng
    if (!isStreaming) return; // N·∫øu ƒë√£ b·∫•m D·ª´ng th√¨ kh√¥ng l√†m g√¨ c·∫£

    // C. Ki·ªÉm tra bi·∫øn currentTime (Ph√≤ng h·ªù tr∆∞·ªùng h·ª£p tr√¨nh duy·ªát c≈© kh√¥ng truy·ªÅn)
    if (!currentTime) currentTime = performance.now();

    // D. Logic Gi·ªõi h·∫°n g·ª≠i (Throttling)
    // Ch·ªâ g·ª≠i ·∫£nh n·∫øu ƒë√£ tr√¥i qua ƒë·ªß 200ms t·ª´ l·∫ßn g·ª≠i tr∆∞·ªõc
    if (currentTime - lastSentTime > SEND_INTERVAL) {
        
        // --- Code x·ª≠ l√Ω ·∫£nh v√† g·ª≠i ƒëi ---
        if (ws && ws.readyState === WebSocket.OPEN) {
            // 1. V·∫Ω video l√™n canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 2. N√©n v√† g·ª≠i
            // quality = 0.5 gi√∫p ·∫£nh nh·∫π h∆°n, g·ª≠i nhanh h∆°n
            const imageData = canvas.toDataURL('image/jpeg', 0.5); 
            ws.send(JSON.stringify({ image: imageData }));
            
            // 3. C·∫≠p nh·∫≠t th·ªùi gian v·ª´a g·ª≠i
            lastSentTime = currentTime;
        }
        // --------------------------------
    }
}

        function drawOverlays(detections) {
            // K·ªπ thu·∫≠t "Time-out": N·∫øu k·∫øt qu·∫£ qu√° c≈© (> 200ms) th√¨ kh√¥ng v·∫Ω n·ªØa
            if (performance.now() - lastDetectionTime > 200) {
                return; // Tho√°t lu√¥n, kh√¥ng v·∫Ω g√¨ c·∫£ -> Khung s·∫Ω bi·∫øn m·∫•t ngay
            }
            detections.forEach(det => {
                const [x1, y1, x2, y2] = det.bbox;
                ctx.strokeStyle = "#FF0000";
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                ctx.fillStyle = "#FF0000";
                ctx.font = "bold 18px Arial";
                ctx.fillText(`${det.label} (${Math.floor(det.conf * 100)}%)`, x1, y1 - 10);
            });
        }

        function calculateFPS() {
            const now = performance.now();
            frameCount++;
            if (now - lastFrameTime >= 1000) {
                fpsSpan.textContent = frameCount;
                frameCount = 0;
                lastFrameTime = now;
            }
        }
    </script>
</html>


